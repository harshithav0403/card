<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      html, body { margin:0; height:100%; overflow:hidden; background:#000; }
      /* raw camera preview sits behind the AR scene until AR gets ready */
      #preview {
        position: fixed; inset: 0;
        width: 100%; height: 100%;
        object-fit: cover; background:#000;
        z-index: 0;
      }
      a-scene { position: fixed; inset: 0; z-index: 1; }
      #log {
        position: fixed; left: 8px; bottom: 8px; color:#cfe7ff;
        font: 14px system-ui; z-index: 2; background: rgba(0,0,0,.35); padding: 6px 8px; border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <!-- Raw camera preview to avoid black screen -->
    <video id="preview" autoplay muted playsinline webkit-playsinline></video>
    <div id="log">opening camera…</div>

    <a-scene
      mindar-image="imageTargetSrc: targets.mind; uiScanning: true; uiError: true"
      color-space="sRGB"
      renderer="colorManagement: true; physicallyCorrectLights: false"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded>

      <a-assets>
        <img id="card" src="6653.jpg" />
        <a-asset-item id="model" src="./phoenix_bird.glb"></a-asset-item>
      </a-assets>

      <!-- Standard AR camera -->
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- simple lighting -->
      <a-entity light="type: ambient; intensity: 1.0"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="0 1 1"></a-entity>

      <a-entity mindar-image-target="targetIndex: 0">
        <!-- invisible alignment plane -->
        <a-plane
          src="#card"
          position="0 0 0"
          width="1" height="0.552"
          material="transparent:true; opacity:0">
        </a-plane>

        <!-- phoenix model (visible, slightly down & forward) -->
        <a-gltf-model
          id="bird"
          src="#model"
          position="0 -0.06 0.08"
          rotation="0 180 0"
          scale="0.006 0.006 0.006">
        </a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      const $ = s => document.querySelector(s);
      const log = m => { $('#log').textContent = m; console.log('[AR]', m); };

      // 1) Open raw camera preview to guarantee permission + working camera
      async function openPreview() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' } },
            audio: false
          });
          const v = $('#preview');
          v.srcObject = stream;
          await new Promise(r => v.onloadedmetadata = r);
          v.play().catch(()=>{});
          log(`camera preview OK (${v.videoWidth}×${v.videoHeight}) — initializing AR…`);
        } catch (e) {
          log(`❌ camera failed: ${e.name} ${e.message}`);
        }
      }

      openPreview();

      // 2) When AR is ready, hide the raw preview (MindAR will show the feed)
      const scene = document.querySelector('a-scene');
      scene.addEventListener('arReady', () => {
        log('✅ AR ready — point at your target image.');
        const v = $('#preview');
        try { v.pause(); v.srcObject && v.srcObject.getTracks().forEach(t => t.stop()); } catch(_) {}
        v.style.display = 'none';
      });
      scene.addEventListener('arError', e => {
        log('❌ AR error: ' + (e.detail?.message || 'unknown'));
      });

      // Optional: model load logs
      const bird = document.getElementById('bird');
      bird.addEventListener('model-loaded', () => log('model loaded ✓'));
      bird.addEventListener('model-error',  e => log('model error: ' + (e.detail?.src || '')));
    </script>
  </body>
</html>
