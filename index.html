<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>MindAR (Three.js) â€” Image â†’ 3D</title>

    <!-- MindAR three adapter (v1.1.5) -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>

    <style>
      html,body{margin:0;height:100%;background:#000;overflow:hidden}
      body>canvas{display:block}
      #ui{position:fixed;left:12px;bottom:12px;z-index:9999;color:#cfe7ff;
          background:rgba(0,0,0,.55);padding:8px 12px;border-radius:10px;
          font:14px system-ui, -apple-system, Segoe UI, Roboto;white-space:pre-line}
      #btn{margin-left:8px;padding:6px 10px;border:1px solid #6aa8ff;border-radius:8px;
           background:#012;border:none;color:#cfe7ff;cursor:pointer}
      #btn:disabled{opacity:.6;cursor:default}
    </style>
  </head>
  <body>
    <div id="ui">Loadingâ€¦ allow camera, then point at your picture. <button id="btn" style="display:none">Start AR</button></div>

    <script type="module">
      // Use Three r136 (known-good with MindAR 1.1.5)
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.module.js';
      import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.136.0/examples/jsm/loaders/GLTFLoader.js';

      const ui = document.getElementById('ui');
      const btn = document.getElementById('btn');
      const say = m => { ui.firstChild.textContent = m; console.log('[AR]', m); };

      // Create once (container = body)
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.body,
        imageTargetSrc: './targets.mind',
        uiLoading: true, uiScanning: true, uiError: true,
        maxTrack: 1
        // we'll pass video constraints at start()
      });
      const { renderer, scene, camera } = mindarThree;

      // Lighting
      scene.add(new THREE.AmbientLight(0xffffff, 0.9));
      const dir = new THREE.DirectionalLight(0xffffff, 0.8);
      dir.position.set(0, 1, 1);
      scene.add(dir);

      // Anchor
      const anchor = mindarThree.addAnchor(0);
      anchor.onTargetFound = () => say('ðŸŽ¯ targetFound');
      anchor.onTargetLost  = () => say('ðŸ‘‹ targetLost');

      // Optional target plane (helps visualize)
      const plane = new THREE.Mesh(
        new THREE.PlaneGeometry(1, 0.7),
        new THREE.MeshBasicMaterial({color:0x11ff11, opacity:0.25, transparent:true})
      );
      anchor.group.add(plane);

      // Load your model
      new GLTFLoader().load('./hornet.glb', gltf => {
        const model = gltf.scene || gltf.scenes[0];
        model.scale.set(0.05, 0.05, 0.05);
        model.position.set(0, 0, 0.03);
        anchor.group.add(model);
        say('Model loaded. Starting cameraâ€¦');
      }, undefined, err => {
        say('âŒ Model load failed: '+(err?.message||err));
      });

      // Try a few camera options until one works
      const attempts = [
        { video: { facingMode: 'environment', width: 1280, height: 720 } },
        { video: { facingMode: 'environment' } },
        { video: { facingMode: 'user' } },
        { } // let browser decide
      ];

      async function startWith(constraint){
        say('Requesting cameraâ€¦');
        await mindarThree.start(constraint);
        renderer.setAnimationLoop(()=>renderer.render(scene, camera));
        say('âœ… AR ready â€” point at your picture.');
      }

      async function startAuto(){
        btn.style.display = 'none';
        for (let i=0;i<attempts.length;i++){
          try { await startWith(attempts[i]); return; }
          catch(e){
            console.warn('start attempt failed', attempts[i], e);
            // If permission error, show button for user gesture retry
            if (/denied|notallowed|permission|insecure/i.test(String(e?.message||e))) {
              btn.style.display = 'inline-block';
              say('Tap â€œStart ARâ€, then allow camera.');
              return;
            }
          }
        }
        btn.style.display = 'inline-block';
        say('Could not start camera automatically. Tap â€œStart ARâ€.');
      }

      btn.addEventListener('click', async ()=>{
        btn.disabled = true; say('Startingâ€¦');
        try { await startAuto(); } finally { btn.disabled = false; }
      });

      // Kick off
      startAuto().catch(e=>{
        console.warn(e);
        btn.style.display = 'inline-block';
        say('Tap â€œStart ARâ€, then allow camera.');
      });

      // Surface hidden errors
      window.addEventListener('error', e => console.warn('window error:', e.message||e));
      window.addEventListener('unhandledrejection', e => console.warn('promise rejection:', e.reason));
    </script>
  </body>
</html>
